<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My E-Commerce</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .auth, .products, .cart { margin-bottom: 2em; }
    .product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    input, button { padding: 5px; margin: 5px; }
    #logout-btn { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Welcome to My E-Commerce</h1>

  <div class="auth">
    <h2>Login / Register</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
    <button id="logout-btn" onclick="logout()" style="display:none;">Logout</button>
    <p id="auth-status"></p>
  </div>

  <div class="products">
    <h2>Products</h2>
    <div id="products"></div>
  </div>

  <div class="cart">
    <h2>Cart</h2>
    <ul id="cart-items"></ul>
    <button onclick="checkout()">Checkout</button>
  </div>

  <script>
    const API_USERS = '/users';
    const API_PRODUCTS = '/products';
    const API_ORDERS = '/orders';

    let token = localStorage.getItem('token');
    let cart = [];

    function setAuthStatus(msg, success = false) {
      const status = document.getElementById('auth-status');
      status.textContent = msg;
      status.style.color = success ? 'green' : 'red';
    }

    function register() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      fetch(`${API_USERS}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
      .then(res => res.ok ? setAuthStatus("Registered successfully", true) : res.json().then(data => setAuthStatus(data.error)))
    }

    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      fetch(`${API_USERS}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          token = data.token;
          localStorage.setItem('token', token);
          document.getElementById('logout-btn').style.display = 'inline-block';
          setAuthStatus("Logged in!", true);
        } else {
          setAuthStatus(data.error);
        }
      });
    }

    function logout() {
      localStorage.removeItem('token');
      token = null;
      setAuthStatus("Logged out", true);
      document.getElementById('logout-btn').style.display = 'none';
    }

    function loadProducts() {
      fetch(`${API_PRODUCTS}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('products');
          container.innerHTML = '';
          data.forEach(product => {
            const div = document.createElement('div');
            div.className = 'product';
            div.innerHTML = `
              <h3>${product.name}</h3>
              <p>Price: $${product.price}</p>
              <button onclick="addToCart(${product.id}, '${product.name}', ${product.price})">Add to cart</button>
            `;
            container.appendChild(div);
          });
        });
    }

    function addToCart(id, name, price) {
      cart.push({ id, name, price });
      updateCart();
    }

    function updateCart() {
      const ul = document.getElementById('cart-items');
      ul.innerHTML = '';
      cart.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name} - $${item.price}`;
        ul.appendChild(li);
      });
    }

    function checkout() {
      if (!token) return alert("Please login first.");
      fetch(`${API_ORDERS}/checkout`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ items: cart })
      })
      .then(res => res.ok ? alert("Order placed!") : alert("Error placing order"))
      .then(() => { cart = []; updateCart(); });
    }

    // Init
    if (token) {
      document.getElementById('logout-btn').style.display = 'inline-block';
      setAuthStatus("Logged in", true);
    }

    loadProducts();
  </script>
</body>
</html>
